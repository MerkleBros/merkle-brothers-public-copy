server {

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/merkle-brothers-website/public;

        # Add index.php to the list if you are using PHP
        index index.html;
        server_name www.merklebros.com merklebros.com; # managed by Certbot

        location / {

                #Added in for caching
                proxy_cache my_zone;
                add_header X-Proxy-Cache $upstream_cache_status;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_set_header X-NginX-Proxy true;

                #Adding in for caching (patrick). Most of the rest of this file is the same as the default configuration. 
                #The caching rules are as suggested here: https://github.com/h5bp/server-configs-nginx/blob/master/h5bp/location/expires.conf

                #Do not cache html/json
                location ~* \.(?:manifest|appcache|html?|xml|json)$ {
                  add_header Cache-Control "max-age=0";
                }

                #Recommended max age 2592000 seconds
                location ~* \.(?:jpg|jpeg|png|)$ {
                  access_log off;
                  add_header Cache-Control "max-age=86400";
                }

                #Recommended max age is 31536000 seconds.
                location ~* \.(?:css|js)$ {
                  add_header Cache-Control "max-age=86400";
                  access_log off;
                }

                #For caching
                include proxy_params;

                try_files $uri @app;
        }

        location @app {

                proxy_pass http://localhost:3000;
                proxy_redirect off;
        }


        listen [::]:443 ssl ipv6only=on; # managed by Certbot
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/www.merklebros.com/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/www.merklebros.com/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
    if ($host = merklebros.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = www.merklebros.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80 ;
    listen [::]:80 ;
    server_name www.merklebros.com merklebros.com;
    return 404; # managed by Certbot
}
